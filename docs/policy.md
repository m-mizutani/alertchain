# Policy

AlertChain has two types of policies: "Alert Policy" and "Action Policy". They are written in the Rego language. This document describes the input and output schemas for these policies.

## Alert Policy

### Package

The package name for Alert Policy must follow the naming convention below:

```rego
package alert.{schema}
```

Here, `{schema}` must match the `{schema}` specified when receiving event data. For example, if the endpoint path for receiving data via Pub/Sub is `/alert/pubsub/my_alert`, the policy `package alert.my_alert` will be called.

### Input

The input for Alert Policy will be the structured data (mainly JSON) received from the previous phase. For example, if the following message is input via Google Cloud Pub/Sub:

```
{
    "message": {
        "data": "eyJuYW1lIjoiaG9nZSJ9Cg==",
    },
}
```

From the Pub/Sub schema, `message.data` is extracted, and `eyJuYW1lIjoiaG9nZSJ9Cg==` is Base64 decoded to `{"name":"hoge"}`. This data is stored in Rego's `input`. The policy will determine whether this data will be treated as an alert or not based on this data.

### Output

Once the alert determination is made, store the data with the schema below in the `alert` set. The stored data will be treated as an alert.

- `title` (string, required): Title of the alert
- `description` (string, optional): Human-readable explanation about the alert
- `source` (string, optional): Data source
- `params` (array, optional): Array of parameters
  - `key` (string, required): Key of the parameter
  - `value` (any, required): Value of the parameter.
  - `type` (string, optional): Type of the parameter.

The `params` field (parameter) serves not only to extract event data fields but also to accommodate user-defined values. For instance, users can add their own `severity` key parameter to determine the appropriate action. Parameters bind the alert and can be added or replaced by the action policy. (Refer to the Action Policy section for more details)

### Example

```rego
package alert.my_alert

alert[res] {
    input.name == "hoge"
    res := {
        "title": "detected hoge",
        "params": [
            {
                "key": "color",
                "value": "blue",
            },
        ],
    }
}
```

In this example, the policy checks if the input contains the name "hoge". If it does, an alert will be created with the title "detected hoge" and a parameter of "color" set to "blue".

## Action Policy

An Action Policy is responsible for defining the following:

- Next action to execute
- Arguments for the next action
- New or replacement parameters for the next action

### Package

The package name for an Action Policy must follow the format shown below:

```rego
package action.{action_id}
```

`{action_id}` should match the `id` field in the `actions` setting in the Jsonnet configuration. For example, `package action.create_issue`.

`package action.main` is a reserved and special action policy that is always evaluated first. This policy must be evaluated with all alerts. Subsequent action policies with the format `package action.{action_id}` (e.g. `package action.blue`) will be evaluated after performing their corresponding action, such as the "blue" action. Then, the action policy should determine the next action to execute.

![Flow of action policy](https://user-images.githubusercontent.com/605953/232349211-4bcc7abe-72ef-436a-916c-2b24953d99ed.jpg)

### Input

An Action Policy accepts the following input:

- `input.alert`: Alert data
  - `title`: Title of the alert generated by the alert policy
  - `data`: Original event data
  - `params`: Array of parameters
- `input.result`: The result of the executed action (optional)

Using this input, the action policy can process the alert data and determine the most appropriate action to perform next, along with the necessary arguments and parameters.

### Output

After evaluating the action policy, if the next action is required, set the `action` field according to the schema described below:

- `id`: This is the ID of the next action to be executed. Ensure that it is defined within the `actions` setting in the Jsonnet configuration file.
- `args`: This is a key-value style map containing the arguments for the next action. The specific arguments are defined on a per-action basis.
- `params`: This is an array of parameters. If a parameter with the same key already exists within the array, it will be replaced with the new value.